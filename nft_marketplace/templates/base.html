{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'pages/css/style.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
<header class="header">
    <div class="logo">
        <a href="/">
            <img src="https://ton.org/download/ton_symbol.svg" alt="TON Logo">
            <h1 class="logo__text">RareBay</h1>
        </a>
    </div>
    <div class="search-bar">
        <input type="text" placeholder="Search NFTs, collections, creators...">
    </div>
    <nav class="nav">
        <div class="nav-group">
            <a href="{% url 'feedback' %}">Feedback</a>
            <a href="{% url 'collections' %}">Collections</a>
        </div>
        <div id="profileContainer">
            <button id="connectButton">Подключить кошелек</button>
        </div>
    </nav>
</header>

<div id="qrCode"></div>
{% block content %}
{% endblock %}

<footer class="footer">
    <!-- Footer content here -->
</footer>

<script>
    function showQRCode(authLink) {
        const qrContainer = document.getElementById('qrCode');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: authLink,
            width: 250,
            height: 250
        });
    }

    function removeQRCode() {
        document.getElementById('qrCode').innerHTML = '';
    }

    function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(';').shift() : null;
    }

    function updateConnectButton(address) {
        const connectButton = document.getElementById('connectButton');
        if (address) {
            connectButton.textContent = address.slice(0, 5) +'...'+ address.slice(43, 48);
            connectButton.onclick = function() {
                window.location.href = `/profile/${address}`;
            };
        } else {
            connectButton.textContent = "Подключить кошелек";
            connectButton.onclick = connectWebSocket;
        }
    }

    function connectWebSocket() {
        const socket = new WebSocket("ws://194.87.131.18/ws/auth");

        socket.onopen = () => console.log("Connected to WebSocket");

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "auth_link") {
                showQRCode(data.payload.auth_link);
            } else if (data.type === "auth_success") {
                const { address, session_id } = data.payload;

                setCookie("session_id", session_id, 7);
                setCookie("address_wallet", address, 7);

                removeQRCode();
                updateConnectButton(address);
            }
        };

        socket.onerror = (error) => console.error("WebSocket Error: ", error);
        socket.onclose = () => console.log("WebSocket connection closed");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const addressWallet = getCookie('address_wallet');
        updateConnectButton(addressWallet);
    });

</script>

</body>
</html>

